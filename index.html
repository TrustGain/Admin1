<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Admin With TarstGain </title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --gold: #FFD700; 
            --gold-dark: #B8860B;
            --bg-dark: #020202; 
            --surface: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 215, 0, 0.15); 
        }
        
        body { 
            background: var(--bg-dark); 
            color: #fff; 
            font-family: 'Poppins', sans-serif; 
            min-height: 100vh;
            background-image: radial-gradient(circle at top right, rgba(255, 215, 0, 0.07), transparent 40%);
        }

        .gold-gradient-text { 
            background: linear-gradient(135deg, #FFF5B7 0%, #FFD700 50%, #B8860B 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            font-family: 'Orbitron', sans-serif; 
        }

        .glass-panel { 
            background: var(--surface); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--border); 
            border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .admin-input { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 215, 0, 0.1); 
            color: white; 
            padding: 16px; 
            border-radius: 16px; 
            outline: none; 
            width: 100%;
            transition: 0.3s;
        }
        .admin-input:focus { border-color: var(--gold); background: rgba(255, 255, 255, 0.06); }

        .btn-elite { 
            background: linear-gradient(45deg, #B8860B, #FFD700); 
            color: black; 
            font-weight: 900; 
            padding: 16px 24px; 
            border-radius: 16px; 
            text-transform: uppercase; 
            font-size: 11px;
            letter-spacing: 2px;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .tab-btn { 
            padding: 16px 20px; 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase; 
            color: #555; 
            border-bottom: 2px solid transparent;
            transition: 0.3s;
            white-space: nowrap;
        }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }

        .table-container { 
            overflow-x: auto; 
            scrollbar-width: thin;
        }
        
        ::-webkit-scrollbar { height: 4px; width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 10px; }

        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .stats-grid > div:last-child { grid-column: span 2; }
        }
    </style>
</head>
<body class="p-4 md:p-10">

<!-- Login Screen -->
<div id="login-screen" class="fixed inset-0 bg-[#020202] z-[9999] flex items-center justify-center hidden">
    <div class="glass-panel p-10 w-full max-w-md text-center">
        <i class="fas fa-user-shield text-3xl gold-gradient-text mb-6"></i>
        <h2 class="text-2xl font-black gold-gradient-text mb-8 tracking-tighter">MASTER ACCESS</h2>
        <input type="password" id="admin-pass" placeholder="Enter Command Key" class="admin-input text-center">
        <button onclick="adminLogin()" class="btn-elite w-full mt-6">Authorize Control</button>
    </div>
</div>

<!-- Main UI -->
<div id="admin-ui" class="max-w-6xl mx-auto hidden">
    <header class="flex flex-col md:flex-row justify-between items-end mb-12 gap-8">
        <div>
            <span class="text-yellow-500 text-[10px] font-black uppercase tracking-[0.4em] mb-2 block">ðŸŒŸ System Root ðŸŒŸ</span>
            <h1 class="text-4xl font-black gold-gradient-text">COMMAND CENTER</h1>
        </div>
        <div class="stats-grid grid grid-cols-3 gap-4 w-full md:w-auto">
            <div class="glass-panel px-6 py-4 text-center">
                <span id="total-users" class="text-xl font-bold">0</span>
                <p class="text-[8px] text-gray-500 font-black uppercase">Members</p>
            </div>
            <div class="glass-panel px-6 py-4 text-center">
                <span id="pending-withdraws" class="text-xl font-bold text-red-500">0</span>
                <p class="text-[8px] text-gray-500 font-black uppercase">Pending</p>
            </div>
            <div onclick="handleLogout()" class="glass-panel flex items-center justify-center px-4 cursor-pointer text-gray-600">
                <i class="fas fa-power-off"></i>
            </div>
        </div>
    </header>

    <div class="flex border-b border-white/5 mb-10 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('tab-settings')" class="tab-btn active" id="btn-tab-settings">Parameters</button>
        <button onclick="switchTab('tab-withdrawals')" class="tab-btn" id="btn-tab-withdrawals">Financials</button>
        <button onclick="switchTab('tab-tasks')" class="tab-btn" id="btn-tab-tasks">200 Task Matrix</button>
        <button onclick="switchTab('tab-users')" class="tab-btn" id="btn-tab-users">User Vault</button>
    </div>

    <!-- Settings -->
    <div id="tab-settings" class="tab-content space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glass-panel p-8">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8 tracking-[0.3em]">System Economics</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Task Reward (à§³)</label>
                        <input type="number" id="set-task-reward" class="admin-input mt-1">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Stream Ad Reward (à§³)</label>
                        <input type="number" id="set-ad-reward" class="admin-input mt-1">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Ref Commission (%)</label>
                        <input type="number" id="set-ref-commission" class="admin-input mt-1" placeholder="e.g. 10">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Signup Bonus (à§³)</label>
                        <input type="number" id="set-signup-bonus" class="admin-input mt-1" placeholder="e.g. 5">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Min Withdraw (à§³)</label>
                        <input type="number" id="set-min-withdraw" class="admin-input mt-1">
                    </div>
                </div>
            </div>
            <div class="glass-panel p-8">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8 tracking-[0.3em]">Notices, Ads & Security</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Bonus Ad URL</label>
                        <input type="text" id="set-ad-link" class="admin-input mt-1">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Notice Title</label>
                        <input type="text" id="set-notice-title" class="admin-input mt-1">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Notice Message</label>
                        <textarea id="set-notice-text" class="admin-input mt-1 h-24"></textarea>
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer p-4 bg-white/5 rounded-xl">
                        <input type="checkbox" id="set-notice-active" class="h-5 w-5 accent-yellow-500">
                        <span class="text-[10px] uppercase font-bold">Active Notice Modal</span>
                    </label>
                    <hr class="border-white/5 my-2">
                    <!-- Telegram Controls -->
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Telegram Channel Link</label>
                        <input type="text" id="set-tg-link" class="admin-input mt-1" placeholder="https://t.me/yourchannel">
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer p-4 bg-white/5 rounded-xl border border-blue-500/20">
                        <input type="checkbox" id="set-force-tg" class="h-5 w-5 accent-blue-500">
                        <span class="text-[10px] uppercase font-bold">Force Telegram Join (Before Task)</span>
                    </label>
                </div>
            </div>
        </div>
        <button onclick="saveGlobalSettings()" class="btn-elite w-full py-6">Commit All Changes</button>
    </div>

    <!-- Withdrawals -->
    <div id="tab-withdrawals" class="tab-content hidden">
        <div class="glass-panel table-container">
            <table class="w-full text-left text-[11px]">
                <thead class="bg-white/5 text-gray-500 uppercase tracking-widest">
                    <tr><th class="p-6">Member</th><th class="p-6">Amount</th><th class="p-6">Method/Number</th><th class="p-6 text-right">Action</th></tr>
                </thead>
                <tbody id="withdraw-list" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>

    <!-- Task Matrix (200 Units) -->
    <div id="tab-tasks" class="tab-content hidden">
        <!-- Bulk Control Section -->
        <div class="glass-panel p-8 mb-8">
            <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-6 tracking-[0.3em]">Bulk Control (All 200 Tasks)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-[9px] text-gray-500 uppercase font-bold">Set Universal Link</label>
                    <input type="text" id="bulk-task-link" class="admin-input mt-1" placeholder="Enter link for all 200 tasks">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase font-bold">Set Universal Code</label>
                    <input type="text" id="bulk-task-code" class="admin-input mt-1" placeholder="Enter code for all 200 tasks">
                </div>
            </div>
            <button onclick="applyBulkTasks()" class="btn-elite w-full mt-6">Apply to All Units</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="glass-panel p-8 h-fit sticky top-10">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8">Edit Individual Unit</h3>
                <div class="space-y-4">
                    <select id="task-selector" onchange="loadTaskDetails()" class="admin-input text-yellow-500 font-bold"></select>
                    <input type="text" id="task-link" class="admin-input" placeholder="Execution Link">
                    <p class="text-[8px] text-gray-600 uppercase mt-2">Leave code empty for direct reward (timer based)</p>
                    <input type="text" id="task-code" class="admin-input" placeholder="Verification Code (Optional)">
                    <button onclick="saveTaskDetails()" class="btn-elite w-full mt-4">Save Unit</button>
                </div>
            </div>
            <div class="md:col-span-2 glass-panel table-container max-h-[70vh]">
                <table class="w-full text-[10px] text-left">
                    <thead class="bg-white/5 sticky top-0 text-gray-500 uppercase font-black">
                        <tr><th class="p-5">ID</th><th class="p-5">Type</th><th class="p-5">Code</th></tr>
                    </thead>
                    <tbody id="task-table-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Vault -->
    <div id="tab-users" class="tab-content hidden">
        <div class="glass-panel p-10 max-w-2xl mx-auto">
            <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-10 tracking-[0.3em] text-center">Asset Management</h3>
            <div class="space-y-6">
                <input type="email" id="user-email-search" class="admin-input" placeholder="User Email">
                <input type="number" id="user-balance-adjust" class="admin-input" placeholder="Set Balance (à§³)">
                <button onclick="updateUserBalance()" class="btn-elite w-full py-5">Override Assets</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, query, getDocs, deleteDoc, orderBy, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCIXm_8gXbAQiqK-iog_jtd7o6EiozL9oA",
        authDomain: "trustgain-9c1e9.firebaseapp.com",
        projectId: "trustgain-9c1e9",
        storageBucket: "trustgain-9c1e9.firebasestorage.app",
        messagingSenderId: "320806460423",
        appId: "1:320806460423:web:f75fe40dbe575128ecdea2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "sabbirsir.com@gmail.com";

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('admin-ui').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            startSystem();
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-ui').classList.add('hidden');
        }
    });

    window.adminLogin = async () => {
        const pass = document.getElementById('admin-pass').value;
        try { await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pass); } 
        catch (e) { Swal.fire('Error', 'Invalid Access Key', 'error'); }
    };

    window.handleLogout = () => signOut(auth);

    let globalSettings = {};

    function startSystem() {
        setupTaskSelector();
        loadGlobalSettings();
        syncStats();
        loadWithdrawals();
    }

    async function syncStats() {
        const usersSnap = await getDocs(collection(db, "users"));
        document.getElementById('total-users').innerText = usersSnap.size;
        onSnapshot(collection(db, "withdraws"), s => {
            document.getElementById('pending-withdraws').innerText = s.size;
        });
    }

    function loadGlobalSettings() {
        onSnapshot(doc(db, "admin", "settings"), (s) => {
            if(s.exists()) {
                globalSettings = s.data();
                document.getElementById('set-task-reward').value = globalSettings.taskReward || 0;
                document.getElementById('set-ad-reward').value = globalSettings.adReward || 0;
                document.getElementById('set-ref-commission').value = globalSettings.refCommission || 0;
                document.getElementById('set-signup-bonus').value = globalSettings.signupBonus || 0;
                document.getElementById('set-min-withdraw').value = globalSettings.minWithdraw || 50;
                document.getElementById('set-ad-link').value = globalSettings.adLink || '';
                document.getElementById('set-notice-title').value = globalSettings.noticeTitle || '';
                document.getElementById('set-notice-text').value = globalSettings.noticeText || '';
                document.getElementById('set-notice-active').checked = globalSettings.noticeActive || false;
                
                // Telegram Controls Loading
                document.getElementById('set-tg-link').value = globalSettings.tgLink || '';
                document.getElementById('set-force-tg').checked = globalSettings.forceTG || false;
                
                if(!document.getElementById('tab-tasks').classList.contains('hidden')) {
                    renderTaskTable();
                }
            }
        });
    }

    window.saveGlobalSettings = async () => {
        const data = {
            taskReward: parseFloat(document.getElementById('set-task-reward').value) || 0,
            adReward: parseFloat(document.getElementById('set-ad-reward').value) || 0,
            refCommission: parseFloat(document.getElementById('set-ref-commission').value) || 0,
            signupBonus: parseFloat(document.getElementById('set-signup-bonus').value) || 0,
            minWithdraw: parseFloat(document.getElementById('set-min-withdraw').value) || 50,
            adLink: document.getElementById('set-ad-link').value,
            noticeTitle: document.getElementById('set-notice-title').value,
            noticeText: document.getElementById('set-notice-text').value,
            noticeActive: document.getElementById('set-notice-active').checked,
            // Telegram Saving
            tgLink: document.getElementById('set-tg-link').value,
            forceTG: document.getElementById('set-force-tg').checked
        };
        await setDoc(doc(db, "admin", "settings"), data, {merge: true});
        Swal.fire({ title: 'Success', text: 'Global Parameters Deployed', icon: 'success', background: '#0a0a0a', color: '#fff' });
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('btn-' + id).classList.add('active');
        if(id === 'tab-tasks') renderTaskTable();
    };

    function loadWithdrawals() {
        onSnapshot(query(collection(db, "withdraws"), orderBy("timestamp", "desc")), s => {
            const list = document.getElementById('withdraw-list');
            list.innerHTML = "";
            s.forEach(d => {
                const data = d.data();
                list.innerHTML += `
                    <tr class="hover:bg-white/5">
                        <td class="p-6"><b>${data.email}</b></td>
                        <td class="p-6">${data.requested}à§³</td>
                        <td class="p-6">${data.method}</td>
                        <td class="p-6 flex justify-end gap-2">
                            <button onclick="processWithdraw('${d.id}', 'approve')" class="p-2 bg-green-500/20 text-green-500 rounded-lg"><i class="fas fa-check"></i></button>
                            <button onclick="processWithdraw('${d.id}', 'reject', '${data.email}', ${data.requested})" class="p-2 bg-red-500/20 text-red-500 rounded-lg"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>`;
            });
        });
    }

    window.processWithdraw = async (id, action, email, amt) => {
        if(confirm(`Confirm ${action}?`)) {
            if(action === 'reject') await updateDoc(doc(db, "users", email), { balance: increment(amt) });
            await deleteDoc(doc(db, "withdraws", id));
        }
    };

    // 200 Task Logic
    function setupTaskSelector() {
        const sel = document.getElementById('task-selector');
        sel.innerHTML = `<option value="">Select Task Unit</option>`;
        for(let i=1; i<=200; i++) sel.innerHTML += `<option value="${i}">TASK UNIT #${i}</option>`;
    }

    window.loadTaskDetails = () => {
        const id = document.getElementById('task-selector').value;
        if(!id) return;
        document.getElementById('task-link').value = globalSettings[`task${id}_link`] || '';
        document.getElementById('task-code').value = globalSettings[`task${id}_code`] || '';
    };

    window.saveTaskDetails = async () => {
        const id = document.getElementById('task-selector').value;
        if(!id) return;
        await setDoc(doc(db, "admin", "settings"), {
            [`task${id}_link`]: document.getElementById('task-link').value,
            [`task${id}_code`]: document.getElementById('task-code').value
        }, {merge: true});
        Swal.fire({ title: 'Saved', text: `Unit #${id} Updated`, icon: 'success', background: '#0a0a0a', color: '#fff' });
        renderTaskTable();
    };

    window.applyBulkTasks = async () => {
        const bulkLink = document.getElementById('bulk-task-link').value;
        const bulkCode = document.getElementById('bulk-task-code').value;

        if(!bulkLink && !bulkCode) {
            return Swal.fire('Error', 'Please enter link or code to update', 'error');
        }

        const confirmAction = await Swal.fire({
            title: 'Are you sure?',
            text: "This will update ALL 200 tasks instantly!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#FFD700',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Update All'
        });

        if (confirmAction.isConfirmed) {
            Swal.fire({ title: 'Updating...', text: 'Deploying to 200 units', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            const updates = {};
            for(let i=1; i<=200; i++) {
                if(bulkLink) updates[`task${i}_link`] = bulkLink;
                if(bulkCode) updates[`task${i}_code`] = bulkCode;
            }

            try {
                await setDoc(doc(db, "admin", "settings"), updates, {merge: true});
                Swal.fire('Success', 'All 200 Tasks have been updated.', 'success');
                renderTaskTable();
            } catch (e) {
                Swal.fire('Error', 'Update failed: ' + e.message, 'error');
            }
        }
    };

    function renderTaskTable() {
        const body = document.getElementById('task-table-body');
        const fragment = document.createDocumentFragment();
        body.innerHTML = "";
        for(let i=1; i<=200; i++) {
            const code = globalSettings[`task${i}_code`];
            const row = document.createElement('tr');
            row.className = "hover:bg-white/5 transition";
            row.innerHTML = `
                <td class="p-5 font-bold text-yellow-500">#${i}</td>
                <td class="p-5 text-gray-500">${code ? 'CODE PROTECTED' : 'AUTO-TIMER'}</td>
                <td class="p-5 font-mono">${code || '---'}</td>
            `;
            fragment.appendChild(row);
        }
        body.appendChild(fragment);
    }

    window.updateUserBalance = async () => {
        const email = document.getElementById('user-email-search').value;
        const bal = parseFloat(document.getElementById('user-balance-adjust').value);
        if(!email) return;
        try {
            await updateDoc(doc(db, "users", email), { balance: bal });
            Swal.fire({ title: 'Success', text: 'Asset Balance Overridden', icon: 'success', background: '#0a0a0a', color: '#fff' });
        } catch (e) { Swal.fire('Error', 'User Not Found', 'error'); }
    };
</script>
</body>
</html>